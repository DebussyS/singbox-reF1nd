name: Build Minimal sing-box Core

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'sing-box version (tag/branch) to build'
        type: string
        required: false
        default: 'reF1nd-main'
      force:
        description: 'Force rebuild even if unchanged'
        type: boolean
        required: false
        default: false
  schedule:
    - cron: '0 0 * * *'
  repository_dispatch:
    types: [singbox_push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Prepare context
        id: prep
        shell: bash
        run: |
          UPSTREAM_REPO="https://github.com/reF1nd/sing-box.git"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            REF="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ] && [ -n "${{ github.event.client_payload.version }}" ]; then
            REF="${{ github.event.client_payload.version }}"
          else
            REF="reF1nd-main"
          fi
          FORCE="false"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE="true"
          fi
          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> "$GITHUB_ENV"
          echo "REF=$REF" >> "$GITHUB_ENV"
          echo "FORCE=$FORCE" >> "$GITHUB_ENV"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "upstream_repo=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
          echo "force=$FORCE" >> "$GITHUB_OUTPUT"
      - name: Resolve upstream commit SHA
        id: upstream
        shell: bash
        run: |
          set -e
          SHA=$(git ls-remote --exit-code --heads "${{ steps.prep.outputs.upstream_repo }}" "refs/heads/${REF}" | cut -f1) || true
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --exit-code --tags "${{ steps.prep.outputs.upstream_repo }}" "refs/tags/${REF}^{}" | cut -f1) || true
          fi
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote "${{ steps.prep.outputs.upstream_repo }}" HEAD | cut -f1)
          fi
          SHORT_SHA="${SHA:0:7}"
          echo "UPSTREAM_SHA=$SHA" >> "$GITHUB_ENV"
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "short=$SHORT_SHA" >> "$GITHUB_OUTPUT"
      - name: Restore last processed state
        id: cache-restore
        uses: actions/cache/restore@v3
        with:
          path: upstream_state/${{ steps.prep.outputs.ref }}
          key: singbox-state-${{ steps.prep.outputs.ref }}-${{ steps.upstream.outputs.sha }}
          restore-keys: |
            singbox-state-${{ steps.prep.outputs.ref }}-
      - name: Decide if build is needed
        id: decide
        shell: bash
        run: |
          if [ "$FORCE" = "true" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Manual force build requested."
            exit 0
          fi
          mkdir -p "upstream_state/${REF}"
          PREV=""
          [ -f "upstream_state/${REF}/sha.txt" ] && PREV=$(cat "upstream_state/${REF}/sha.txt")
          if [ "$PREV" = "${UPSTREAM_SHA}" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No upstream changes. Skipping build."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Upstream changed from '$PREV' to '${UPSTREAM_SHA}'. Building..."
          fi
      - name: Checkout official sing-box repository at resolved commit
        if: steps.decide.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ steps.upstream.outputs.sha }}
          fetch-depth: 1

      - name: Set up Go
        if: steps.decide.outputs.changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Fix version in source code
        if: steps.decide.outputs.changed == 'true'
        id: fix-version
        shell: bash
        run: |
          VERSION="reF1nd"
          echo "Fixed version: $VERSION"
          
          FILES=$(find . -name "*.go" -type f | xargs grep -l -E "(CoreVersion|Version).*=.*\"(unknown|dev|v[0-9])\"" || true)
          if [ -n "$FILES" ]; then
            echo "$FILES" | while read file; do
              echo "Fixing version in: $file"
              sed -i 's/\(CoreVersion\|Version\).*=.*\"\(unknown\|dev\|v[0-9][^"]*\)\"/\1 = "'"$VERSION"'"/g' "$file"
            done
          else
            echo "Trying alternative pattern..."
            FILES2=$(find . -name "*.go" -type f | xargs grep -l -E "(const|var).*(CoreVersion|Version)" || true)
            if [ -n "$FILES2" ]; then
              echo "$FILES2" | while read file; do
                echo "Checking: $file"
                sed -i 's/\(CoreVersion\|Version\).*=.*\"[^\"]*\"/\1 = "'"$VERSION"'"/g' "$file"
              done
            fi
          fi
          
          echo "Version fix completed"

      - name: Derive version and names
        if: steps.decide.outputs.changed == 'true'
        id: meta
        shell: bash
        run: |
          VERSION="reF1nd"
          OUT="sing-box-linux-arm64-${VERSION}-${SHORT_SHA}"
          ZIP="${OUT}.zip"
          TAG="sing-box-${VERSION}-${SHORT_SHA}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "OUT=$OUT" >> "$GITHUB_ENV"
          echo "ZIP=$ZIP" >> "$GITHUB_ENV"
          echo "TAG=$TAG" >> "$GITHUB_ENV"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "out=$OUT" >> "$GITHUB_OUTPUT"
          echo "zip=$ZIP" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
      - name: Build sing-box for arm64
        if: steps.decide.outputs.changed == 'true'
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          go build -v -o "${OUT}" -trimpath -ldflags="-s -w" -tags="with_quic with_clash_api" ./cmd/sing-box
      - name: Verify binary architecture
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          file "${OUT}"
          echo "Binary architecture verification completed"
      - name: Package zip
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          install -m 0755 "${OUT}" sing-box
          zip -9 -j "${ZIP}" sing-box
          rm -f sing-box
      - name: Generate checksums
        if: steps.decide.outputs.changed == 'true'
        run: |
          sha256sum "${ZIP}" > "${ZIP}.sha256"
      - name: Upload Artifact
        if: steps.decide.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-minimal-reF1nd-arm64-${{ steps.upstream.outputs.short }}-zip
          path: |
            ${{ steps.meta.outputs.zip }}
            ${{ steps.meta.outputs.zip }}.sha256
      - name: Create GitHub Release and upload assets
        if: steps.decide.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: sing-box minimal reF1nd (${{ steps.upstream.outputs.short }})
          body: |
            Source: reF1nd/sing-box @ ${{ steps.upstream.outputs.short }}
            GOOS/GOARCH: linux/arm64
            Tags: with_quic with_clash_api
          prerelease: true
          files: |
            ${{ steps.meta.outputs.zip }}
            ${{ steps.meta.outputs.zip }}.sha256
      - name: Update state and save cache
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          mkdir -p "upstream_state/${REF}"
          echo "${UPSTREAM_SHA}" > "upstream_state/${REF}/sha.txt"
      - name: Save cache
        if: steps.decide.outputs.changed == 'true'
        uses: actions/cache/save@v3
        with:
          path: upstream_state/${{ steps.prep.outputs.ref }}
          key: singbox-state-${{ steps.prep.outputs.ref }}-${{ steps.upstream.outputs.sha }}
