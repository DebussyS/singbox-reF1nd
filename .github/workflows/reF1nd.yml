name: Build Minimal sing-box Core

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'sing-box version (tag/branch/commit)'
        type: string
        required: false
        default: 'reF1nd-main'
      force:
        description: 'Force rebuild even if unchanged'
        type: boolean
        required: false
        default: false
  schedule:
    - cron: '0 0 * * *'
  repository_dispatch:
    types: [singbox_push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Prepare context
        id: prep
        run: |
          UPSTREAM_REPO="https://github.com/reF1nd/sing-box.git"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            REF="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ] && [ -n "${{ github.event.client_payload.version }}" ]; then
            REF="${{ github.event.client_payload.version }}"
          else
            REF="reF1nd-main"
          fi

          FORCE="false"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE="true"
          fi

          echo "REF=$REF" >> $GITHUB_ENV
          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
          echo "FORCE=$FORCE" >> $GITHUB_ENV
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "upstream=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
          echo "force=$FORCE" >> $GITHUB_OUTPUT

      - name: Resolve SHA (tag/branch/commit)
        id: upstream
        run: |
          set -e

          # Try branch
          SHA=$(git ls-remote --heads "${UPSTREAM_REPO}" "refs/heads/${REF}" | cut -f1)
          
          # Try tag
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --tags "${UPSTREAM_REPO}" "${REF}^{}" | cut -f1)
          fi

          # Try raw commit
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote "${UPSTREAM_REPO}" "${REF}" | cut -f1)
          fi

          # If still empty â†’ FAIL
          if [ -z "$SHA" ]; then
            echo "ERROR: REF '${REF}' not found (branch/tag/commit)."
            exit 1
          fi

          SHORT="${SHA:0:7}"

          echo "UPSTREAM_SHA=$SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT" >> $GITHUB_ENV
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short=$SHORT" >> $GITHUB_OUTPUT

      - name: Load cache state
        id: cache-restore
        uses: actions/cache/restore@v3
        with:
          path: upstream_state/${{ steps.prep.outputs.ref }}
          key: singbox-state-${{ steps.prep.outputs.ref }}-${{ steps.upstream.outputs.sha }}
          restore-keys: |
            singbox-state-${{ steps.prep.outputs.ref }}-

      - name: Decide build or skip
        id: decide
        run: |
          if [ "$FORCE" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          mkdir -p upstream_state/${REF}
          PREV=""
          [ -f upstream_state/${REF}/sha.txt ] && PREV=$(cat upstream_state/${REF}/sha.txt)

          if [ "$PREV" = "$UPSTREAM_SHA" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in upstream. Skip build."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Upstream changed â†’ build triggered."
          fi

      - name: Checkout upstream
        if: steps.decide.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ steps.upstream.outputs.sha }}
          fetch-depth: 1

      - name: Setup Go
        if: steps.decide.outputs.changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Define build metadata
        id: meta
        if: steps.decide.outputs.changed == 'true'
        run: |
          VERSION="reF1nd"
          TAGS="with_quic with_utls with_clash_api"

          OUT="sing-box-linux-arm64-${VERSION}-${SHORT_SHA}"
          ZIP="${OUT}.zip"
          TAG="sing-box-${VERSION}-${SHORT_SHA}"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAGS=$TAGS" >> $GITHUB_ENV
          echo "OUT=$OUT" >> $GITHUB_ENV
          echo "ZIP=$ZIP" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "out=$OUT" >> $GITHUB_OUTPUT
          echo "zip=$ZIP" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build sing-box (arm64 minimal)
        if: steps.decide.outputs.changed == 'true'
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          go build \
            -trimpath \
            -o "${OUT}" \
            -ldflags="-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
            -tags="${TAGS}" \
            ./cmd/sing-box

      - name: Verify arch
        if: steps.decide.outputs.changed == 'true'
        run: file "${OUT}"

      - name: Package zip
        if: steps.decide.outputs.changed == 'true'
        run: |
          install -m 0755 "${OUT}" sing-box
          zip -9 -j "${ZIP}" sing-box
          rm sing-box

      - name: SHA256
        if: steps.decide.outputs.changed == 'true'
        run: sha256sum "${ZIP}" > "${ZIP}.sha256"

      - name: Upload artifact
        if: steps.decide.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-minimal-arm64-${{ steps.upstream.outputs.short }}
          path: |
            ${{ steps.meta.outputs.zip }}
            ${{ steps.meta.outputs.zip }}.sha256

      - name: Release
        if: steps.decide.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: sing-box minimal (${{ steps.upstream.outputs.short }})
          body: |
            Source: reF1nd/sing-box @ ${{ steps.upstream.outputs.short }}
            GOOS/GOARCH: linux/arm64
            Tags: ${{ steps.meta.outputs.tags }}
          prerelease: true
          files: |
            ${{ steps.meta.outputs.zip }}
            ${{ steps.meta.outputs.zip }}.sha256

      - name: Save state
        if: steps.decide.outputs.changed == 'true'
        run: |
          mkdir -p upstream_state/${REF}
          echo "${UPSTREAM_SHA}" > upstream_state/${REF}/sha.txt

      - name: Cache save
        if: steps.decide.outputs.changed == 'true'
        uses: actions/cache/save@v3
        with:
          path: upstream_state/${{ steps.prep.outputs.ref }}
          key: singbox-state-${{ steps.prep.outputs.ref }}-${{ steps.upstream.outputs.sha }}
